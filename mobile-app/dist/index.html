<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f3460">
    <meta name="description" content="Biblia bilingüe Español/Tzotzil con IA Nevin">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: blob: 'unsafe-inline' 'unsafe-eval'; connect-src * 'self' https: wss:;">
    <title>Tzotzil Bible</title>
    <link rel="icon" type="image/png" href="static/images/Designer.png">
    <link rel="manifest" href="static/manifest.json">
    <link rel="apple-touch-icon" href="static/images/Designer.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="static/css/style.css" rel="stylesheet">
    <link href="static/css/nevin.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Poppins:wght@500&family=Fira+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
      :root {
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
      }
      
      * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
      
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        overscroll-behavior: none;
        background: linear-gradient(135deg, #1a1a2e 0%, #0d1117 100%);
      }
      
      body {
        padding-top: var(--safe-area-inset-top);
        padding-bottom: var(--safe-area-inset-bottom);
      }
      
      .app-container {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        flex-direction: column;
      }
      
      .loading-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #0d1117 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: #00f3ff;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      
      .loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
      }
      
      .loading-screen img {
        width: 120px; height: 120px;
        animation: pulse 2s ease-in-out infinite;
        border-radius: 24px;
      }
      
      .loading-screen h2 {
        margin-top: 24px;
        font-family: 'Orbitron', sans-serif;
        font-size: 1.6rem;
        text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
      }
      
      .spinner {
        width: 44px; height: 44px;
        border: 3px solid rgba(0, 243, 255, 0.2);
        border-radius: 50%;
        border-top-color: #00f3ff;
        animation: spin 0.8s linear infinite;
        margin-top: 32px;
      }
      
      .status-text {
        margin-top: 16px;
        opacity: 0.7;
        font-size: 14px;
        text-align: center;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .offline-banner {
        position: fixed;
        top: var(--safe-area-inset-top);
        left: 0; right: 0;
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        text-align: center;
        padding: 10px 16px;
        font-size: 13px;
        font-weight: 500;
        z-index: 10001;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }
      
      .offline-banner.show { transform: translateY(0); }
      
      .webview-container {
        flex: 1;
        position: relative;
        overflow: hidden;
      }
      
      .webview-container iframe {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        border: none;
      }
      
      .error-container {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        text-align: center;
        color: #00f3ff;
        height: 100%;
      }
      
      .error-container.show { display: flex; }
      
      .error-container h2 {
        font-family: 'Orbitron', sans-serif;
        margin-bottom: 16px;
      }
      
      .error-container p {
        opacity: 0.7;
        margin-bottom: 24px;
        max-width: 300px;
      }
      
      .retry-btn {
        padding: 14px 36px;
        background: linear-gradient(135deg, #00f3ff 0%, #00d4aa 100%);
        color: #1a1a2e;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      
      .retry-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="offline-banner" class="offline-banner">
        <i class="bi bi-wifi-off"></i> Modo sin conexión
    </div>
    
    <div class="app-container">
        <div id="loading-screen" class="loading-screen">
            <img src="static/images/Designer.png" alt="Tzotzil Bible">
            <h2>Tzotzil Bible</h2>
            <div class="spinner"></div>
            <p class="status-text" id="status-text">Conectando...</p>
        </div>
        
        <div id="webview-container" class="webview-container" style="display:none;">
            <iframe id="app-frame" allow="clipboard-write"></iframe>
        </div>
        
        <div id="error-container" class="error-container">
            <img src="static/images/Designer.png" alt="Tzotzil Bible" style="width:100px;height:100px;border-radius:20px;margin-bottom:24px;">
            <h2 id="error-title">Sin Conexión</h2>
            <p id="error-msg">No pudimos conectar con el servidor. Verifica tu conexión a internet.</p>
            <button class="retry-btn" onclick="retryConnection()">
                <i class="bi bi-arrow-clockwise"></i> Reintentar
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function() {
        'use strict';
        
        const API_BASE = 'https://tzotzil-bible-chyrris.replit.app';
        
        const loadingScreen = document.getElementById('loading-screen');
        const webviewContainer = document.getElementById('webview-container');
        const errorContainer = document.getElementById('error-container');
        const appFrame = document.getElementById('app-frame');
        const offlineBanner = document.getElementById('offline-banner');
        const statusText = document.getElementById('status-text');
        const errorTitle = document.getElementById('error-title');
        const errorMsg = document.getElementById('error-msg');
        
        let isOnline = navigator.onLine;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        const TIMEOUT = 15000;
        
        function updateOnlineStatus() {
          isOnline = navigator.onLine;
          offlineBanner.classList.toggle('show', !isOnline);
        }
        
        window.addEventListener('online', () => {
          updateOnlineStatus();
          if (errorContainer.classList.contains('show')) {
            retryConnection();
          }
        });
        
        window.addEventListener('offline', updateOnlineStatus);
        
        function showLoading(message) {
          statusText.textContent = message || 'Cargando...';
          loadingScreen.classList.remove('hidden');
          webviewContainer.style.display = 'none';
          errorContainer.classList.remove('show');
        }
        
        function showWebview() {
          loadingScreen.classList.add('hidden');
          webviewContainer.style.display = 'block';
          errorContainer.classList.remove('show');
        }
        
        function showError(title, message) {
          loadingScreen.classList.add('hidden');
          webviewContainer.style.display = 'none';
          errorTitle.textContent = title;
          errorMsg.textContent = message;
          errorContainer.classList.add('show');
        }
        
        window.retryConnection = function() {
          retryCount = 0;
          initApp();
        };
        
        async function checkServerHealth() {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);
          
          try {
            const response = await fetch(API_BASE + '/health', {
              signal: controller.signal,
              mode: 'cors',
              cache: 'no-store'
            });
            clearTimeout(timeoutId);
            return response.ok;
          } catch (error) {
            clearTimeout(timeoutId);
            return false;
          }
        }
        
        async function initApp() {
          showLoading('Verificando conexión...');
          updateOnlineStatus();
          
          if (!isOnline) {
            showError('Sin Conexión', 'No hay conexión a internet. Conéctate para usar la aplicación.');
            return;
          }
          
          showLoading('Conectando al servidor...');
          
          const isHealthy = await checkServerHealth();
          
          if (!isHealthy) {
            retryCount++;
            if (retryCount < MAX_RETRIES) {
              showLoading(`Reintentando (${retryCount}/${MAX_RETRIES})...`);
              setTimeout(initApp, 2000);
              return;
            }
            showError('Error de Conexión', 'No pudimos conectar con el servidor. Intenta de nuevo más tarde.');
            return;
          }
          
          showLoading('Cargando aplicación...');
          
          appFrame.src = API_BASE;
          
          appFrame.onload = function() {
            showWebview();
          };
          
          appFrame.onerror = function() {
            showError('Error de Carga', 'No pudimos cargar la aplicación. Intenta de nuevo.');
          };
          
          setTimeout(function() {
            if (loadingScreen.classList.contains('hidden') === false) {
              showWebview();
            }
          }, 8000);
        }
        
        document.addEventListener('backbutton', function(e) {
          e.preventDefault();
          try {
            if (appFrame.contentWindow && appFrame.contentWindow.history.length > 1) {
              appFrame.contentWindow.history.back();
            }
          } catch (err) {
            console.log('Cannot access iframe history');
          }
        }, false);
        
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(initApp, 300);
        });
      })();
    </script>
</body>
</html>
